name: Publish to npm

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform a dry run (no actual publishing)'
        required: false
        default: false
        type: boolean

jobs:
  publish-npm:
    name: Publish WASM Package to npm
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install wasm-pack
      run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

    - name: Build WASM package
      working-directory: orphos-wasm
      run: wasm-pack build --target web --release

    - name: Verify package
      working-directory: orphos-wasm/pkg
      run: npm pack --dry-run

    - name: Publish to npm (dry run)
      if: inputs.dry_run
      working-directory: orphos-wasm/pkg
      run: npm publish --dry-run
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Publish to npm
      if: '!inputs.dry_run'
      working-directory: orphos-wasm/pkg
      run: npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Create summary
      run: |
        echo "### Published Package" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… @fullhuman/orphos (npm)" >> $GITHUB_STEP_SUMMARY
        if [ "${{ inputs.dry_run }}" = "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This was a dry run. No package was actually published." >> $GITHUB_STEP_SUMMARY
        fi
